<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

  <!--- Mapbox -->
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.css' rel='stylesheet' />

  <!-- Selectize -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/css/selectize.bootstrap3.min.css" integrity="sha256-ze/OEYGcFbPRmvCnrSeKbRTtjG4vGLHXgOqsyLFTRjg=" crossorigin="anonymous" />

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css" integrity="sha256-HtCCUh9Hkh//8U1OwcbD8epVEUdBvuI8wj1KtqMhNkI=" crossorigin="anonymous" />

  <style>

    #map {
      position: absolute;
      top: 0px;
      left: 0px;
      height: 100%;
      width: 100%;
    }

    .mapboxgl-popup-content {
      border-radius: 10px;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 20px;
    }

    .mapboxgl-popup-tip {
      border-top-color: rgba(255, 255, 255, 0.9);
    }

    .btn-help {
      width: 100%;
    }

    .col-btn {
      max-width: 100px !important;
    }

    .col {
      padding: 0;
      margin: 0;
    }

    .selectize-input::after {
      visibility: hidden;
    }

    .selectize-input {
      border: 0;
      margin: 10px;
      width: calc(100% - 20px);
      box-shadow: 0 2px 2px rgba(0, 0, 0, 0.19);
      padding: 15px;
    }

    .selectize-dropdown {
      border: 0;
      margin: 0px 10px 0px 10px;
      width: calc(100% - 20px);
      box-shadow: 0 2px 2px rgba(0, 0, 0, 0.19);
    }

    .selectize-dropdown-content>.option {
      padding: 5px 15px 5px 15px;
    }

    /* Max Height Dropdown */

    .selectize-dropdown,
    .selectize-dropdown.form-control {
      max-height: 30vh !important;
    }

    .selectize-dropdown-content {
      max-height: 30vh !important;
    }

    .animated {
      -webkit-animation-duration: 0.3s;
      animation-duration: 0.3s;
      -webkit-animation-fill-mode: both;
      animation-fill-mode: both;
    }
  </style>

  <title>Map | Cal Poly Apps</title>
</head>

<body>

  <select class="input" id='filter-input' type='text' name='filter' placeholder='Try "POLS 334-01"' autocomplete="off"></select>
  <div id='map'></div>

  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/js/standalone/selectize.min.js"></script>

  <script>
    function debounce(wait, func, immediate) {
      var timeout;
      return function() {
        var context = this,
          args = arguments;
        var later = function() {
          timeout = null;
          if (!immediate) func.apply(context, args);
        };
        var callNow = immediate && !timeout;
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
        if (callNow) func.apply(context, args);
      };
    };

    function getName(feature) {
      if (!feature.properties.type) {
        return feature.properties.ref_en + ": " + feature.properties.name;
      } else if(feature.properties.type === "sections") {
        return feature.properties.department.trim() + " " + feature.properties.courseNumber.trim() + "-" + feature.properties.sectionNumber.trim() + ": " + feature.properties.courseName.trim();
      } else if(feature.properties.type === "classrooms") {
        if(feature.properties.room.startsWith("0")) {
          feature.properties.room = feature.properties.room.substr(1);
        }
        return feature.properties.bldg + "-" + feature.properties.room;
      }
    }

    function getDescription(feature) {
      if (!feature.properties.type) {
        return "<b>" + getName(feature) + "</b></br>" +
          (feature.properties.alt_name ? "<b>Known as:</b> " + feature.properties.alt_name.split(";").join(" | ") : "")
      } else if(feature.properties.type === "sections") {
        return "<b>" + getName(feature) + "</b></br>" +
          "Building: " + feature.properties.bldgName.trim() + "<br/>" +
          "Room: " + feature.properties.room.trim();
      } else if(feature.properties.type === "classrooms") {
        return "<b>" + getName(feature) + "</b></br>" +
               "Building: " + feature.properties.bldgName.trim() + "<br/>" +
               "Room: " + feature.properties.room.trim();
      }
    }

    var sections, buildings, classrooms;
    $.when(
      $.getJSON("sections.json", function(data) {
        sections = data;
      }),
      $.getJSON("buildings.json", function(data) {
        buildings = data;
      }),
      $.getJSON("classrooms.json", function(data) {
        classrooms = data;
      })
    ).then(function() {

      mapboxgl.accessToken = 'pk.eyJ1Ijoia2V2aW5zdW5kYXIiLCJhIjoiY2lmNjF6aGdmMDM1MDdzbHVpcThyZjF4YyJ9.1NKie7hjfYG3dNPYLhRizA';

      var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v9',
        center: [-120.661090, 35.300559],
        pitch: 20,
        zoom: 16
      });

      map.loadImage("marker.png", function(error, image) {
        map.addImage("custom-marker", image);

        map.addControl(new mapboxgl.GeolocateControl({
          positionOptions: {
            enableHighAccuracy: true
          },
          trackUserLocation: true
        }), "bottom-right");

        map.addControl(new mapboxgl.NavigationControl(), "bottom-right");

        map.on('load', function() {

          // Insert the layer beneath any symbol layer.
          var layers = map.getStyle().layers;

          var labelLayerId;
          for (var i = 0; i < layers.length; i++) {
            if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
              labelLayerId = layers[i].id;
              break;
            }
          }

          map.addLayer({
            'id': '3d-buildings',
            'source': 'composite',
            'source-layer': 'building',
            'filter': ['==', 'extrude', 'true'],
            'type': 'fill-extrusion',
            'minzoom': 15,
            'paint': {
              'fill-extrusion-color': '#aaa',

              // use an 'interpolate' expression to add a smooth transition effect to the
              // buildings as the user zooms in
              'fill-extrusion-height': [
                "interpolate", ["linear"],
                ["zoom"],
                15, 0,
                15.05, ["get", "height"]
              ],
              'fill-extrusion-base': [
                "interpolate", ["linear"],
                ["zoom"],
                15, 0,
                15.05, ["get", "min_height"]
              ],
              'fill-extrusion-opacity': .6
            }
          }, labelLayerId);

          map.addLayer({
            "id": "sections",
            "type": "symbol",
            "interactive": true,
            "source": {
              "type": "geojson",
              "data": sections
            },
            "layout": {
              "icon-image": "custom-marker",
              "icon-allow-overlap": true
            }
          });

          map.addLayer({
            "id": "buildings",
            "type": "symbol",
            "interactive": true,
            "source": {
              "type": "geojson",
              "data": buildings
            },
            "layout": {
              "icon-image": "custom-marker",
              "icon-allow-overlap": true
            }
          });
          
          map.addLayer({
            "id": "classrooms",
            "type": "symbol",
            "interactive": true,
            "source": {
              "type": "geojson",
              "data": classrooms
            },
            "layout": {
              "icon-image": "custom-marker",
              "icon-allow-overlap": true
            }
          });

          var lastPopup = null;

          function showDescriptionPopup(feature) {
            var coordinates = feature.geometry.coordinates.slice();
            var description = getDescription(feature);
            
            if (lastPopup) {
              lastPopup.remove();
            }
            
            lastPopup = new mapboxgl.Popup({ offset: [0, -10], className: "animated fadeIn" })
              .setLngLat(coordinates)
              .setHTML(description)
              .addTo(map);
          }

          function displayFilteredMap(filtered) {
            
            // Set the filter to populate features into the layer.
            var classNumberFilter = filtered.sections.map(function(feature) {
              return feature.properties.classNumber;
            });
            map.setFilter('sections', ['match', ['get', 'classNumber'], classNumberFilter.length != 0 ? classNumberFilter : ["NULL"], true, false]);

            // Set the filter to populate features into the layer.
            var buildingRefFilter = filtered.buildings.map(function(feature) {
              return feature.properties.ref;
            });
            map.setFilter('buildings', ['match', ['get', 'ref'], buildingRefFilter.length != 0 ? buildingRefFilter : ["NULL"], true, false]);
            
            // Set the filter to populate features into the layer.
            var roomRefFilter = filtered.classrooms.map(function(feature) {
              return feature.properties.roomRef;
            });
            map.setFilter('classrooms', ['match', ['get', 'roomRef'], roomRefFilter.length != 0 ? roomRefFilter : ["NULL"], true, false]);

            // Update map bounds
            var bounds = new mapboxgl.LngLatBounds();
            filtered.sections.forEach(function(feature) {
              bounds.extend(feature.geometry.coordinates);
            });
            filtered.buildings.forEach(function(feature) {
              bounds.extend(feature.geometry.coordinates);
            });
            filtered.classrooms.forEach(function(feature) {
              bounds.extend(feature.geometry.coordinates);
            });

            if (lastPopup) {
              lastPopup.remove();
            }
            map.fitBounds(bounds, { maxZoom: 17, padding: 100 });

            if (filtered.sections.length + filtered.buildings.length + filtered.classrooms.length === 1) {
              map.on("moveend",function() {
                showDescriptionPopup(filtered.sections[0] || filtered.buildings[0] || filtered.classrooms[0]);
              })
            }
          }

          map.on('click', 'sections', function(e) {
            map.flyTo({ center: e.features[0].geometry.coordinates });
            showDescriptionPopup(e.features[0]);
          });

          map.on('click', 'buildings', function(e) {
            map.flyTo({ center: e.features[0].geometry.coordinates });
            showDescriptionPopup(e.features[0]);
          });
          
          map.on('click', 'classrooms', function(e) {
            map.flyTo({ center: e.features[0].geometry.coordinates });
            showDescriptionPopup(e.features[0]);
          });

          // Change the cursor to a pointer when the mouse is over the sections layer.
          map.on('mouseenter', 'sections', function() {
            map.getCanvas().style.cursor = 'pointer';
          });

          // Change it back to a pointer when it leaves.
          map.on('mouseleave', 'sections', function() {
            map.getCanvas().style.cursor = '';
          });

          var selectData = $.map(sections.features, function(obj, index) {
            return {
              type: "sections",
              name: getName(obj),
              id: "sections-" + index
            }
          });

          selectData = selectData.concat($.map(buildings.features, function(obj, index) {
            return {
              type: "buildings",
              name: getName(obj),
              id: "buildings-" + index
            }
          }))
          
          selectData = selectData.concat($.map(classrooms.features, function(obj, index) {
            return {
              type: "classrooms",
              name: getName(obj),
              id: "classrooms-" + index
            }
          }))

          var selectize = $('#filter-input').selectize({
            options: selectData,
            optgroups: [
              { $order: 2, type: 'classrooms', name: 'Classrooms' },
              { $order: 1, type: 'buildings', name: 'Buildings' },
              { $order: 3, type: 'sections', name: 'Sections' }
            ],
            valueField: 'id',
            labelField: 'name',
            searchField: ['name'],
            optgroupField: 'type',
            optgroupLabelField: 'name',
            optgroupValueField: 'type',
            render: {
              optgroup_header: function(data, escape) {
                return '<div class="optgroup-header">' + escape(data.name) + '</div>';
              }
            },
            maxOptions: 30,
            onType: debounce(100, function(text) {

              var filtered = {
                "buildings": [],
                "sections": [],
                "classrooms": []
              }

              this.currentResults.items.slice(0, this.settings.maxOptions).forEach(function(item) {
                var type = item.id.split("-")[0];
                var index = parseInt(item.id.split("-")[1]);
                if (type === "buildings") {
                  filtered.buildings.push(buildings.features[index]);
                } else if (type === "sections") {
                  filtered.sections.push(sections.features[index]);
                } else if (type === "classrooms") {
                  filtered.classrooms.push(classrooms.features[index]);
                }
              });

              displayFilteredMap(filtered);

            }),
            onChange: debounce(100, function(id) {

              var filtered = {
                "buildings": [],
                "sections": [],
                "classrooms": []
              }

              var type = id.split("-")[0];
              var index = parseInt(id.split("-")[1]);
              if (type === "buildings") {
                filtered.buildings.push(buildings.features[index]);
              }
              else if (type === "sections") {
                filtered.sections.push(sections.features[index]);
              } else if (type === "classrooms") {
                filtered.classrooms.push(classrooms.features[index]);
              }

              displayFilteredMap(filtered)
            })
          });
        });
      });
    });
  </script>

</body>

</html>














              